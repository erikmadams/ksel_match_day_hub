<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>KSEL Match Day Lobby</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div class="max-w-6xl mx-auto p-6">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg mb-6 p-6 border-l-4 border-red-500">
            <div class="flex items-center justify-between mb-0 min-h-[72px]">
                <div class="flex items-center">
                    <img src="https://raw.githubusercontent.com/erikmadams/ksel-fortnite-results/main/KSEL_Header_Black_48x198.png" alt="KSEL Logo" style="height: 48px; width: 198px;" class="rounded" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="flex items-center justify-center text-white font-bold rounded text-lg" style="background-color: #EE2A3E; height: 48px; width: 198px; display: none;">
                        KSEL
                    </div>
                </div>
                
                <div class="flex-1 text-center">
                    <h1 class="text-3xl font-bold text-gray-800">Match Day Lobby</h1>
                    <p class="text-gray-600" id="headerSubtitle">Battle Bus Schedule - Live Updates</p>
                </div>
                
                <div class="flex gap-2">
                    <button 
                        onclick="window.location.href='https://erikmadams.github.io/ksel-fortnite-results/'"
                        class="text-white px-6 rounded-lg inline-flex items-center justify-center text-center gap-2 font-medium transition-colors hover:opacity-90 h-11"
                        style="background-color: #EE2A3E"
                    >
                        <i data-lucide="file-text" class="w-4 h-4"></i>
                        Results Entry
                    </button>
                    <button 
                        onclick="window.location.href='https://erikmadams.github.io/fortnite-dashboard/'"
                        class="text-white px-6 rounded-lg inline-flex items-center justify-center text-center gap-2 font-medium transition-colors hover:opacity-90 h-11"
                        style="background-color: #EE2A3E"
                    >
                        <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                        Leaderboard
                    </button>
                </div>
            </div>
        </div>

        <!-- Countdown Timer Display (Always visible when enabled) -->
        <div id="countdownDisplay" class="bg-white rounded-xl shadow-lg mb-6 p-6 border-l-4" style="display: none; border-color: #8C15E0;">
            <div class="text-center">
                <div class="flex items-center justify-center gap-2 mb-4">
                    <i data-lucide="timer" class="w-6 h-6" style="color: #8C15E0;"></i>
                    <h2 class="text-2xl font-bold text-gray-800">Next Match</h2>
                </div>
                <div id="countdownTimer" class="text-4xl font-mono font-bold mb-2" style="color: #8C15E0;">
                    --d --h --m --s
                </div>
                <div id="countdownTargetDate" class="text-gray-600 text-lg">
                    Loading...
                </div>
            </div>
        </div>

        <!-- Countdown Timer Admin Controls -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 admin-section" style="display: none;">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800 text-left flex items-center gap-2">
                    <i data-lucide="timer" class="w-5 h-5 text-red-600"></i>
                    Countdown Timer Control
                </h2>
                <div class="flex gap-2">
                    <button 
                        id="toggleCountdownBtn"
                        onclick="toggleCountdown()"
                        class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg inline-flex items-center justify-center gap-2 font-medium transition-colors text-sm"
                    >
                        <i data-lucide="power" class="w-4 h-4"></i>
                        <span id="toggleCountdownText">Enable Countdown</span>
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Timer Settings -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Timer Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Target Date</label>
                            <input 
                                type="date" 
                                id="countdownDate"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Target Time</label>
                            <input 
                                type="time" 
                                id="countdownTime"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                            >
                        </div>
                        <button 
                            onclick="setNextThursday()"
                            class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors"
                        >
                            Set to Next Thursday 7:00 PM
                        </button>
                        <button 
                            onclick="updateCountdownTarget()"
                            class="w-full text-white px-4 py-2 rounded-lg font-medium transition-colors hover:opacity-90"
                            style="background-color: #EE2A3E"
                        >
                            Update Countdown Target
                        </button>
                    </div>
                </div>
                
                <!-- Current Status -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Current Status</h3>
                    <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                        <div class="flex justify-between">
                            <span class="text-sm font-medium text-gray-600">Timer Status:</span>
                            <span id="timerStatus" class="text-sm font-bold text-gray-800">Disabled</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm font-medium text-gray-600">Target Date:</span>
                            <span id="currentTargetDate" class="text-sm font-bold text-gray-800">Not Set</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm font-medium text-gray-600">Time Remaining:</span>
                            <span id="adminTimeRemaining" class="text-sm font-bold text-gray-800">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Time Display -->
        <div class="bg-white rounded-xl shadow-lg mb-6 p-4">
            <div class="text-center">
                <div class="text-lg font-medium text-gray-700">Current Time</div>
                <div class="text-3xl font-bold text-gray-800" id="currentTime">--:--:-- --</div>
            </div>
        </div>

        <!-- Two Battle Bus Schedule Columns -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Bus Schedule A (3:30 Release Time) -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-800 text-left flex items-center gap-2">
                        <i data-lucide="clock" class="w-5 h-5 text-red-600"></i>
                        Bus Schedule A - 3:30 Release
                    </h2>
                    <div class="flex gap-2 admin-controls" style="display: none;">
                        <button 
                            onclick="addBusLaunch('A')"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg inline-flex items-center justify-center gap-2 font-medium transition-colors text-sm"
                        >
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Add Bus
                        </button>
                        <button 
                            onclick="clearSchedule('A')"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg inline-flex items-center justify-center gap-2 font-medium transition-colors text-sm"
                        >
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                            Clear
                        </button>
                    </div>
                </div>
                
                <div id="launchScheduleA" class="space-y-3 max-h-[800px] overflow-y-auto">
                    <!-- Bus launches for Schedule A will be populated here -->
                </div>
            </div>

            <!-- Bus Schedule B (4:00 Release Time) -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-800 text-left flex items-center gap-2">
                        <i data-lucide="clock" class="w-5 h-5 text-red-600"></i>
                        Bus Schedule B - 4:00 Release
                    </h2>
                    <div class="flex gap-2 admin-controls" style="display: none;">
                        <button 
                            onclick="addBusLaunch('B')"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg inline-flex items-center justify-center gap-2 font-medium transition-colors text-sm"
                        >
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Add Bus
                        </button>
                        <button 
                            onclick="clearSchedule('B')"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg inline-flex items-center justify-center gap-2 font-medium transition-colors text-sm"
                        >
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                            Clear
                        </button>
                    </div>
                </div>
                
                <div id="launchScheduleB" class="space-y-3 max-h-[800px] overflow-y-auto">
                    <!-- Bus launches for Schedule B will be populated here -->
                </div>
            </div>
        </div>

        <!-- Team Management Row -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 admin-section" style="display: none;">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800 text-left flex items-center gap-2">
                    <i data-lucide="users" class="w-5 h-5 text-red-600"></i>
                    Team Management
                </h2>
                <div class="flex gap-2">
                    <button 
                        onclick="openTeamModal()"
                        class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg inline-flex items-center justify-center gap-2 font-medium transition-colors text-sm"
                    >
                        <i data-lucide="edit" class="w-4 h-4"></i>
                        Edit
                    </button>
                    <button 
                        onclick="randomizeTeams()"
                        class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg inline-flex items-center justify-center gap-2 font-medium transition-colors text-sm"
                    >
                        <i data-lucide="shuffle" class="w-4 h-4"></i>
                        Random
                    </button>
                </div>
            </div>
            
            <div id="teamSummary">
                <!-- Team summary will be populated here -->
            </div>
        </div>

        <!-- Tournament Status Overview -->
        <div class="bg-white rounded-xl shadow-lg p-6 admin-section" style="display: none;">
            <h2 class="text-xl font-bold text-gray-800 mb-4 text-left flex items-center gap-2">
                <i data-lucide="activity" class="w-5 h-5 text-red-600"></i>
                Tournament Status
            </h2>
            <div id="tournamentStatus">
                <!-- Tournament status will be populated here -->
            </div>
        </div>
    </div>

    <!-- Team Modal -->
    <div id="teamModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-lg max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Edit Team Assignments</h3>
                    <button onclick="closeTeamModal()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Bus</label>
                    <select 
                        id="busSelect" 
                        onchange="loadTeamsForBus()"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                    >
                        <option value="">Choose a bus...</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Match Password</label>
                    <input 
                        type="text" 
                        id="busMatchPassword" 
                        placeholder="Enter match password for this bus" 
                        maxlength="50"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                    >
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Team Names (one per line)</label>
                    <textarea 
                        id="teamNames" 
                        rows="8" 
                        placeholder="Enter team names..."
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                    ></textarea>
                </div>
                <div class="flex justify-end gap-2">
                    <button 
                        onclick="closeTeamModal()"
                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors"
                    >
                        Cancel
                    </button>
                    <button 
                        onclick="saveTeams()"
                        class="text-white px-4 py-2 rounded-lg font-medium transition-colors hover:opacity-90"
                        style="background-color: #EE2A3E"
                    >
                        Save Teams
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Individual Bus Team Assignment Modal -->
    <div id="busTeamModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-lg max-w-lg w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800" id="busTeamModalTitle">Assign Teams to Bus</h3>
                    <button onclick="closeBusTeamModal()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <!-- Match Password Section -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Match Password</label>
                    <input 
                        type="text" 
                        id="individualBusPassword" 
                        placeholder="Enter match password for this bus" 
                        maxlength="50"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                    >
                </div>

                <!-- Method Selection Tabs -->
                <div class="mb-4">
                    <div class="flex border-b border-gray-200">
                        <button 
                            id="manualTabBtn"
                            onclick="switchTeamInputMethod('manual')"
                            class="px-4 py-2 text-sm font-medium border-b-2 border-red-500 text-red-600"
                        >
                            Manual Entry
                        </button>
                        <button 
                            id="csvTabBtn"
                            onclick="switchTeamInputMethod('csv')"
                            class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700"
                        >
                            CSV Upload
                        </button>
                    </div>
                </div>

                <!-- Manual Entry Section -->
                <div id="manualEntry" class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Team Names (one per line)</label>
                    <textarea 
                        id="individualTeamNames" 
                        rows="10" 
                        placeholder="Enter team names, one per line..."
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                    ></textarea>
                    <div class="text-sm text-gray-500 mt-1">
                        Current count: <span id="teamCount">0</span> teams
                    </div>
                </div>

                <!-- CSV Upload Section -->
                <div id="csvEntry" class="mb-4" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload CSV File</label>
                    <input 
                        type="file" 
                        id="csvFileInput" 
                        accept=".csv"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                        onchange="handleCSVUpload(event)"
                    >
                    <div class="mt-2 text-sm text-gray-500">
                        <p>Upload a CSV file with team names. The file should have:</p>
                        <ul class="list-disc list-inside mt-1 space-y-1">
                            <li>Team names in the first column</li>
                            <li>Header row will be ignored</li>
                            <li>One team name per row</li>
                        </ul>
                    </div>
                    <div id="csvPreview" class="mt-3 p-3 bg-gray-50 rounded-lg" style="display: none;">
                        <h4 class="font-medium text-gray-700 mb-2">Preview:</h4>
                        <div id="csvPreviewContent" class="text-sm text-gray-600"></div>
                    </div>
                </div>

                <div class="flex justify-end gap-2">
                    <button 
                        onclick="closeBusTeamModal()"
                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors"
                    >
                        Cancel
                    </button>
                    <button 
                        onclick="saveIndividualBusTeams()"
                        class="text-white px-4 py-2 rounded-lg font-medium transition-colors hover:opacity-90"
                        style="background-color: #EE2A3E"
                    >
                        Save Teams
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables for current bus being edited
        let currentBusId = null;
        let currentBusColumn = null;
        
        // Countdown Timer State
        let countdownState = {
            enabled: false,
            targetDate: null,
            intervalId: null
        };

        // Save countdown state to localStorage
        function saveCountdownState() {
            const stateToSave = {
                enabled: countdownState.enabled,
                targetDate: countdownState.targetDate
            };
            localStorage.setItem('kselCountdownState', JSON.stringify(stateToSave));
        }

        // Load countdown state from localStorage
        function loadCountdownState() {
            try { 
                const savedState = localStorage.getItem('kselCountdownState');
                if (savedState) {
                    const parsed = JSON.parse(savedState);
                    countdownState.enabled = parsed.enabled || false;
                    countdownState.targetDate = parsed.targetDate || null;
                }
            } catch (e) {
                console.log('Error loading countdown state:', e);
                // Reset to defaults if corrupted
                countdownState.enabled = false;
                countdownState.targetDate = null;
            }
        }

        //Save bus schedules to localStorage
        function saveBusSchedules() {
            const scheduleData = {
                busScheduleA: busScheduleA,
                busScheduleB: busScheduleB,
            };
            localStorage.setItem('kselBusSchedules', JSON.stringify(scheduleData));
        }

        //Load bus schedules from localStorage
        function loadBusSchedules() {
            try {
                const savedSchedules = localStorage.getItem('kselBusSchedules');
                if (savedSchedules) {
                    const parsed = JSON.parse(savedSchedules);
                    // Ensure we're getting arrays, not objects
                    busScheduleA = Array.isArray(parsed.busScheduleA) ? parsed.busScheduleA : [];
                    busScheduleB = Array.isArray(parsed.busScheduleB) ? parsed.busScheduleB : [];
                    console.log('Loaded bus schedules - A:', busScheduleA.length, 'B:', busScheduleB.length);
                } else {
                    busScheduleA = [];
                    busScheduleB = [];
                    console.log('No saved bus schedules found');
                }
            } catch (e) {
                console.log('Error loading bus schedules:', e);
                busScheduleA = [];
                busScheduleB = [];
            }
        }    
        // Bus schedules - EMPTY for clean start
        let busScheduleA = [];
        let busScheduleB = [];

        // Check URL parameter - default is player view
        const urlParams = new URLSearchParams(window.location.search);
        const isAdminView = urlParams.get('view') === 'admin';

        // Individual Bus Team Assignment Functions
        function openBusTeamModal(busId, column) {
            if (!isAdminView) return;
            
            currentBusId = busId;
            currentBusColumn = column;
            
            const scheduleData = column === 'A' ? busScheduleA : busScheduleB;
            const bus = scheduleData.find(b => b.id === busId);
            
            if (bus) {
                document.getElementById('busTeamModalTitle').textContent = `Assign Teams to ${bus.busNumber}`;
                document.getElementById('individualBusPassword').value = bus.matchPassword || '';
                document.getElementById('individualTeamNames').value = bus.teams.join('\n');
                updateTeamCount();
                
                // Reset to manual entry tab
                switchTeamInputMethod('manual');
                
                document.getElementById('busTeamModal').classList.remove('hidden');
            }
        }

        function closeBusTeamModal() {
            document.getElementById('busTeamModal').classList.add('hidden');
            currentBusId = null;
            currentBusColumn = null;
        }

        function switchTeamInputMethod(method) {
            const manualTab = document.getElementById('manualTabBtn');
            const csvTab = document.getElementById('csvTabBtn');
            const manualEntry = document.getElementById('manualEntry');
            const csvEntry = document.getElementById('csvEntry');
            
            if (method === 'manual') {
                manualTab.className = 'px-4 py-2 text-sm font-medium border-b-2 border-red-500 text-red-600';
                csvTab.className = 'px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700';
                manualEntry.style.display = 'block';
                csvEntry.style.display = 'none';
            } else {
                manualTab.className = 'px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700';
                csvTab.className = 'px-4 py-2 text-sm font-medium border-b-2 border-red-500 text-red-600';
                manualEntry.style.display = 'none';
                csvEntry.style.display = 'block';
            }
        }

        function updateTeamCount() {
            const textarea = document.getElementById('individualTeamNames');
            const teams = textarea.value
                .split('\n')
                .map(name => name.trim())
                .filter(name => name.length > 0);
            
            document.getElementById('teamCount').textContent = teams.length;
        }

        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                alert('Please select a CSV file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const csvContent = e.target.result;
                const lines = csvContent.split('\n');
                
                // Parse CSV - assume first column contains team names, skip header row
                const teams = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        // Simple CSV parsing - split by comma and take first column
                        const columns = line.split(',');
                        const teamName = columns[0].trim().replace(/"/g, ''); // Remove quotes
                        if (teamName) {
                            teams.push(teamName);
                        }
                    }
                }
                
                if (teams.length > 0) {
                    // Update the manual textarea with parsed teams
                    document.getElementById('individualTeamNames').value = teams.join('\n');
                    updateTeamCount();
                    
                    // Show preview
                    const previewDiv = document.getElementById('csvPreview');
                    const previewContent = document.getElementById('csvPreviewContent');
                    previewContent.innerHTML = `
                        <p><strong>${teams.length} teams found:</strong></p>
                        <div class="mt-2 max-h-32 overflow-y-auto">
                            ${teams.slice(0, 10).map(team => `<div class="py-1">${team}</div>`).join('')}
                            ${teams.length > 10 ? '<div class="py-1 text-gray-500">... and ' + (teams.length - 10) + ' more</div>' : ''}
                        </div>
                    `;
                    previewDiv.style.display = 'block';
                    
                    // Switch back to manual tab to show the results
                    switchTeamInputMethod('manual');
                } else {
                    alert('No team names found in the CSV file');
                }
            };
            
            reader.readAsText(file);
        }

        function saveIndividualBusTeams() {
            if (!isAdminView || !currentBusId || !currentBusColumn) return;
            
            const scheduleData = currentBusColumn === 'A' ? busScheduleA : busScheduleB;
            const bus = scheduleData.find(b => b.id === currentBusId);
            
            if (bus) {
                const teamNames = document.getElementById('individualTeamNames').value
                    .split('\n')
                    .map(name => name.trim())
                    .filter(name => name.length > 0);
                
                const matchPassword = document.getElementById('individualBusPassword').value.trim();
                
                bus.teams = teamNames;
                bus.matchPassword = matchPassword;
                
                saveBusSchedules();
                renderAll();
                closeBusTeamModal();
                
                alert(`Successfully assigned ${teamNames.length} teams to ${bus.busNumber}`);
            }
        }

        // Update the team count as user types
        document.addEventListener('DOMContentLoaded', function() {
            const textarea = document.getElementById('individualTeamNames');
            if (textarea) {
                textarea.addEventListener('input', updateTeamCount);
            }
        });

        // Countdown Timer Functions
        function toggleCountdown() {
            if (!isAdminView) return;
            
            countdownState.enabled = !countdownState.enabled;
            
            if (countdownState.enabled) {
                if (!countdownState.targetDate) {
                    alert('Please set a target date and time first');
                    countdownState.enabled = false;
                    return;
                }
                startCountdown();
            } else {
                stopCountdown();
            }
            
            // Save to localStorage
            saveCountdownState();
            updateCountdownUI();
        }
        
        function startCountdown() {
            if (countdownState.intervalId) {
                clearInterval(countdownState.intervalId);
            }
            
            countdownState.intervalId = setInterval(updateCountdownDisplay, 1000);
            updateCountdownDisplay();
            
            // Show countdown display
            document.getElementById('countdownDisplay').style.display = 'block';
        }

        function stopCountdown() {
            if (countdownState.intervalId) {
                clearInterval(countdownState.intervalId);
                countdownState.intervalId = null;
            }
            
            // Hide countdown display
            document.getElementById('countdownDisplay').style.display = 'none';
        }

        function updateCountdownDisplay() {
            if (!countdownState.enabled || !countdownState.targetDate) {
                return;
            }

            const now = new Date();
            const target = new Date(countdownState.targetDate);
            const timeDiff = target.getTime() - now.getTime();

            if (timeDiff <= 0) {
                // Countdown expired
                document.getElementById('countdownTimer').textContent = 'TOURNAMENT TIME!';
                document.getElementById('countdownTimer').className = 'text-4xl font-mono font-bold text-red-600 mb-2 animate-pulse';
                return;
            }

            const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);

            const formattedTime = `${days}d ${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m ${seconds.toString().padStart(2, '0')}s`;
            
            const timerElement = document.getElementById('countdownTimer');
            timerElement.textContent = formattedTime;
            timerElement.className = 'text-4xl font-mono font-bold mb-2';
            timerElement.style.color = '#8C15E0';
            
            // Update admin display
            if (isAdminView) {
                document.getElementById('adminTimeRemaining').textContent = formattedTime;
            }
        }

        function updateCountdownTarget() {
            if (!isAdminView) return;
            
            const dateInput = document.getElementById('countdownDate').value;
            const timeInput = document.getElementById('countdownTime').value;
            
            if (!dateInput || !timeInput) {
                alert('Please set both date and time');
                return;
            }
            
            const targetDateTime = new Date(`${dateInput}T${timeInput}`);
            const now = new Date();
            
            if (targetDateTime <= now) {
                alert('Target date and time must be in the future');
                return;
            }
            
            countdownState.targetDate = targetDateTime.toISOString();
            
            // Update displays
            const formattedTarget = targetDateTime.toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
            
            document.getElementById('countdownTargetDate').textContent = formattedTarget;
            document.getElementById('currentTargetDate').textContent = formattedTarget;

            // Save to localStorage
            saveCountdownState();
            
            // If countdown is enabled, restart it with new target
            if (countdownState.enabled) {
                startCountdown();
            }
            
            alert('Countdown target updated successfully!');
        }

        function setNextThursday() {
            if (!isAdminView) return;
            
            const now = new Date();
            const daysUntilThursday = (4 - now.getDay() + 7) % 7;
            const nextThursday = new Date(now);
            
            if (daysUntilThursday === 0 && now.getHours() >= 19) {
                // If it's Thursday after 7 PM, set for next Thursday
                nextThursday.setDate(now.getDate() + 7);
            } else {
                nextThursday.setDate(now.getDate() + (daysUntilThursday || 7));
            }
            
            // Set to 7:00 PM
            nextThursday.setHours(19, 0, 0, 0);
            
            // Update form inputs
            const dateString = nextThursday.toISOString().split('T')[0];
            const timeString = '19:00';
            
            document.getElementById('countdownDate').value = dateString;
            document.getElementById('countdownTime').value = timeString;
        }

        function updateCountdownUI() {
            if (!isAdminView) return;
            
            const toggleBtn = document.getElementById('toggleCountdownText');
            const statusText = document.getElementById('timerStatus');
            
            if (countdownState.enabled) {
                toggleBtn.textContent = 'Disable Countdown';
                statusText.textContent = 'Active';
                statusText.className = 'text-sm font-bold text-green-600';
            } else {
                toggleBtn.textContent = 'Enable Countdown';
                statusText.textContent = 'Disabled';
                statusText.className = 'text-sm font-bold text-gray-800';
            }
        }

        // Original functions (keeping existing functionality)
        function getAllBuses() {
            return [...busScheduleA, ...busScheduleB];
        }

        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit', 
                second: '2-digit', 
                hour12: true 
            });
            document.getElementById('currentTime').textContent = timeString;
        }

        function formatTime12Hour(time24) {
            const [hours, minutes] = time24.split(':').map(Number);
            const period = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            return `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
        }

        function getBusStatus(bus) {
            const now = new Date();
            
            // If bus is manually launched
            if (bus.isLaunched && bus.launchTime) {
                const launchTime = new Date(bus.launchTime);
                const timeSinceLaunch = now - launchTime;
                
                // If 7 minutes (420,000 ms) have passed since launch, mark as completed
                if (timeSinceLaunch >= 420000) {
                    return 'completed';
                } else {
                    return 'active';
                }
            }
            
            // If not launched, always show as upcoming
            return 'upcoming';
        }

        function getStatusColor(status) {
            switch(status) {
                case 'completed': return 'bg-gray-100 text-gray-600 border-gray-300';
                case 'active': return 'bg-green-100 text-green-700 border-green-300';
                case 'upcoming': return 'bg-yellow-100 text-yellow-700 border-yellow-300';
                default: return 'bg-gray-100 text-gray-600 border-gray-300';
            }
        }

        function getStatusIcon(status) {
            switch(status) {
                case 'completed': return 'check-circle';
                case 'active': return 'play-circle';
                case 'upcoming': return 'clock';
                default: return 'clock';
            }
        }

        function renderSchedule() {
            renderScheduleColumn('A');
            renderScheduleColumn('B');
        }

        function renderScheduleColumn(column) {
            const scheduleData = column === 'A' ? busScheduleA : busScheduleB;
            const scheduleContainer = document.getElementById(`launchSchedule${column}`);
            
            if (scheduleData.length === 0) {
                scheduleContainer.innerHTML = `<p class="text-gray-500 text-center py-8">No buses scheduled for Schedule ${column}</p>`;
                return;
            }

            scheduleContainer.innerHTML = '';

            scheduleData.forEach(bus => {
                const status = getBusStatus(bus);
                const statusColor = getStatusColor(status);
                const statusIcon = getStatusIcon(status);
                
                const busElement = document.createElement('div');
                busElement.className = `border-2 rounded-lg p-4 transition-colors ${statusColor}`;
                
                // Admin-only launch checkbox
                const launchCheckboxHtml = isAdminView ? `
                    <div class="flex items-center gap-2 mb-2">
                        <input 
                            type="checkbox" 
                            id="launch-${bus.id}" 
                            ${bus.isLaunched ? 'checked' : ''} 
                            onchange="toggleBusLaunch(${bus.id}, '${column}')"
                            class="w-4 h-4 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500"
                        >
                        <label for="launch-${bus.id}" class="text-sm font-medium text-gray-700">
                            ${bus.isLaunched ? 'Bus Launched' : 'Launch Bus'}
                        </label>
                    </div>
                ` : '';
                
                // Show or hide admin buttons based on view
                const adminButtonsHtml = isAdminView ? `
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-medium opacity-75">${bus.teams.length} teams assigned</span>
                        <div class="flex gap-1">
                            <button 
                                onclick="openBusTeamModal(${bus.id}, '${column}')" 
                                class="text-blue-500 hover:text-blue-700 p-1"
                                title="Assign teams to this bus"
                            >
                                <i data-lucide="users" class="w-4 h-4"></i>
                            </button>
                            <button 
                                onclick="removeBus(${bus.id}, '${column}')" 
                                class="text-red-500 hover:text-red-700 p-1"
                                title="Remove this bus"
                            >
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                ` : `
                    <div class="text-center mb-2">
                        <span class="text-xs font-medium opacity-75">${bus.teams.length} teams assigned</span>
                    </div>
                `;
                
                busElement.innerHTML = `
                    <div class="mb-4">
                        <div class="text-center">
                            <div class="text-xl font-bold text-gray-800 mb-2">${bus.busNumber}</div>
                        </div>
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <i data-lucide="${statusIcon}" class="w-5 h-5"></i>
                                <span class="font-bold text-lg">${formatTime12Hour(bus.time)}</span>
                            </div>
                            <div class="text-right">
                                <div class="text-xs opacity-75 font-mono bg-black bg-opacity-20 px-2 py-1 rounded">
                                    Password: ${bus.matchPassword || 'No password'}
                                </div>
                            </div>
                        </div>
                    </div>
                    ${launchCheckboxHtml}
                    ${adminButtonsHtml}
                    <div class="space-y-1">
                        ${bus.teams.map(team => `
                            <div class="bg-white bg-opacity-50 rounded px-2 py-1 text-sm font-medium">
                                ${team}
                            </div>
                        `).join('')}
                    </div>
                `;
                
                scheduleContainer.appendChild(busElement);
            });

            // Re-initialize Lucide icons for new elements
            lucide.createIcons();
        }

        function toggleBusLaunch(busId, column) {
            if (!isAdminView) return;
            
            const scheduleData = column === 'A' ? busScheduleA : busScheduleB;
            const bus = scheduleData.find(b => b.id === busId);
            
            if (bus) {
                bus.isLaunched = !bus.isLaunched;
                if (bus.isLaunched) {
                    bus.launchTime = new Date().toISOString();
                } else {
                    bus.launchTime = null;
                }
                saveBusSchedules();
                renderAll();
            }
        }

        function renderTeamSummary() {
            const summaryContainer = document.getElementById('teamSummary');
            const allBuses = getAllBuses();
            const totalTeams = allBuses.reduce((sum, bus) => sum + bus.teams.length, 0);
            
            summaryContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-blue-50 rounded-lg p-4 text-center border border-blue-200">
                        <div class="text-3xl font-bold text-blue-600">${totalTeams}</div>
                        <div class="text-sm text-blue-600 font-medium">Total Teams</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 text-center border border-green-200">
                        <div class="text-3xl font-bold text-green-600">${allBuses.length}</div>
                        <div class="text-sm text-green-600 font-medium">Total Buses</div>
                    </div>
                    <div class="bg-orange-50 rounded-lg p-4 text-center border border-orange-200">
                        <div class="text-3xl font-bold text-orange-600">${busScheduleA.length}</div>
                        <div class="text-sm text-orange-600 font-medium">Schedule A Buses</div>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4 text-center border border-purple-200">
                        <div class="text-3xl font-bold text-purple-600">${busScheduleB.length}</div>
                        <div class="text-sm text-purple-600 font-medium">Schedule B Buses</div>
                    </div>
                </div>
            `;
        }

        function renderTournamentStatus() {
            const statusContainer = document.getElementById('tournamentStatus');
            const allBuses = getAllBuses();
            
            let upcomingCount = 0;
            let activeCount = 0;
            let completedCount = 0;
            
            allBuses.forEach(bus => {
                const status = getBusStatus(bus);
                switch(status) {
                    case 'upcoming': upcomingCount++; break;
                    case 'active': activeCount++; break;
                    case 'completed': completedCount++; break;
                }
            });

            statusContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-yellow-50 rounded-lg p-4 text-center border border-yellow-200">
                        <div class="text-2xl font-bold text-yellow-600">${upcomingCount}</div>
                        <div class="text-sm text-yellow-600 font-medium">Upcoming Buses</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 text-center border border-green-200">
                        <div class="text-2xl font-bold text-green-600">${activeCount}</div>
                        <div class="text-sm text-green-600 font-medium">Active Buses</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 text-center border border-gray-200">
                        <div class="text-2xl font-bold text-gray-600">${completedCount}</div>
                        <div class="text-sm text-gray-600 font-medium">Completed Buses</div>
                    </div>
                </div>
            `;
        }

        function addBusLaunch(column) {
            if (!isAdminView) return;
            
            const busName = prompt('Enter bus name:');
            const time = prompt(`Enter launch time for Schedule ${column} (HH:MM in 24-hour format):`);
            const matchPassword = prompt('Enter match password for this bus (optional):') || '';
            
            if (time && busName && /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(time)) {
                const newBus = {
                    id: Date.now(),
                    time: time,
                    busNumber: busName,
                    matchPassword: matchPassword,
                    isLaunched: false,
                    launchTime: null,
                    teams: []
                };
                
                if (column === 'A') {
                    busScheduleA.push(newBus);
                    busScheduleA.sort((a, b) => a.time.localeCompare(b.time));
                } else {
                    busScheduleB.push(newBus);
                    busScheduleB.sort((a, b) => a.time.localeCompare(b.time));
                }

                saveBusSchedules();
                renderAll();
            } else if (time && busName) {
                alert('Please enter time in HH:MM format (24-hour)');
            }
        }

        function removeBus(busId, column) {
            if (!isAdminView) return;
            
            const scheduleData = column === 'A' ? busScheduleA : busScheduleB;
            const bus = scheduleData.find(b => b.id === busId);
            
            if (bus && confirm(`Remove ${bus.busNumber} and all its team assignments?`)) {
                if (column === 'A') {
                    const index = busScheduleA.findIndex(b => b.id === busId);
                    if (index > -1) busScheduleA.splice(index, 1);
                } else {
                    const index = busScheduleB.findIndex(b => b.id === busId);
                    if (index > -1) busScheduleB.splice(index, 1);
                }
                saveBusSchedules();
                renderAll();
            }
        }

        function clearSchedule(column) {
            if (!isAdminView) return;
            
            if (confirm(`Are you sure you want to clear Schedule ${column}?`)) {
                if (column === 'A') {
                    busScheduleA = [];
                } else {
                    busScheduleB = [];
                }
                saveBusSchedules();
                renderAll();
            }
        }

        function randomizeTeams() {
            if (!isAdminView) return;
            
            const allBuses = getAllBuses();
            if (allBuses.length === 0) {
                alert('No buses available to randomize teams');
                return;
            }
            
            if (confirm('This will randomize all team assignments across both schedules. Continue?')) {
                const allTeams = allBuses.flatMap(bus => bus.teams);
                const shuffledTeams = [...allTeams].sort(() => Math.random() - 0.5);
                
                let teamIndex = 0;
                allBuses.forEach(bus => {
                    const teamCount = bus.teams.length;
                    bus.teams = shuffledTeams.slice(teamIndex, teamIndex + teamCount);
                    teamIndex += teamCount;
                });

                saveBusSchedules();
                renderAll();
            }
        }

        function openTeamModal() {
            if (!isAdminView) return;
            updateTeamModal();
            const modal = document.getElementById('teamModal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function closeTeamModal() {
            const modal = document.getElementById('teamModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function updateTeamModal() {
            const busSelect = document.getElementById('busSelect');
            busSelect.innerHTML = '<option value="">Choose a bus...</option>';
            
            const allBuses = getAllBuses();
            allBuses.forEach(bus => {
                const option = document.createElement('option');
                option.value = bus.id;
                option.textContent = `${formatTime12Hour(bus.time)} - ${bus.busNumber}`;
                busSelect.appendChild(option);
            });
        }

        function loadTeamsForBus() {
            const busId = parseInt(document.getElementById('busSelect').value);
            const allBuses = getAllBuses();
            const bus = allBuses.find(b => b.id === busId);
            
            if (bus) {
                document.getElementById('teamNames').value = bus.teams.join('\n');
                document.getElementById('busMatchPassword').value = bus.matchPassword || '';
            } else {
                document.getElementById('teamNames').value = '';
                document.getElementById('busMatchPassword').value = '';
            }
        }

        function saveTeams() {
            if (!isAdminView) return;
            
            const busId = parseInt(document.getElementById('busSelect').value);
            const teamNames = document.getElementById('teamNames').value
                .split('\n')
                .map(name => name.trim())
                .filter(name => name.length > 0);
            const matchPassword = document.getElementById('busMatchPassword').value.trim();
            
            if (!busId) {
                alert('Please select a bus');
                return;
            }
            
            // Find the bus in either schedule
            let bus = busScheduleA.find(b => b.id === busId);
            if (!bus) {
                bus = busScheduleB.find(b => b.id === busId);
            }
            
            if (bus) {
                bus.teams = teamNames;
                bus.matchPassword = matchPassword;
                saveBusSchedules();
                renderAll();
                closeTeamModal();
            }
        }

        function renderAll() {
            renderSchedule();
            if (isAdminView) {
                renderTeamSummary();
                renderTournamentStatus();
                updateCountdownUI();
            }
        }

        function setupView() {
            // Load both countdown state and bus schedules from localStorage first
            loadCountdownState();
            loadBusSchedules();
            
            if (isAdminView) {
                // Show admin sections and controls
                document.querySelectorAll('.admin-section').forEach(element => {
                    element.style.display = 'block';
                });
                
                document.querySelectorAll('.admin-controls').forEach(element => {
                    element.style.display = 'flex';
                });
                
                document.title = 'KSEL Match Day Hub - Admin';
                document.getElementById('headerSubtitle').textContent = 'Battle Bus Schedule  Team Assignments  Live Updates';
                
                // Initialize countdown form with next Thursday (if no saved state)
                if (!countdownState.targetDate) {
                    setNextThursday();
                } else {
                    // Load saved target date into form
                    const targetDate = new Date(countdownState.targetDate);
                    const dateString = targetDate.toISOString().split('T')[0];
                    const timeString = targetDate.toTimeString().substring(0, 5);

                    document.getElementById('countdownDate').value = dateString;
                    document.getElementById('countdownTime').value = timeString;

                    // Update target date display
                    const formattedTarget = targetDate.toLocaleString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    });
                    document.getElementById('countdownTargetDate').textContent = formattedTarget;
                    document.getElementById('currentTargetDate').textContent = formattedTarget;
                }
            } else {    
                // Player view is default
                document.title = 'KSEL Match Day - Player View';
                document.getElementById('headerSubtitle').textContent = 'Battle Bus Schedule - Live Updates';
            }
            
            // Check if countdown should be visible (for both admin and player views)
            if (countdownState.enabled && countdownState.targetDate) {
                // Update target date display for player view too
                if (!isAdminView) {
                    const targetDate = new Date(countdownState.targetDate);
                    const formattedTarget = targetDate.toLocaleString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    });
                    document.getElementById('countdownTargetDate').textContent = formattedTarget;
                }
                startCountdown();
            }    
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const teamModal = document.getElementById('teamModal');
            const busTeamModal = document.getElementById('busTeamModal');
            
            if (event.target === teamModal) {
                closeTeamModal();
            }
            if (event.target === busTeamModal) {
                closeBusTeamModal();
            }
        }

        // Initialize the page
        function init() {
            // Initialize Lucide icons
            lucide.createIcons();
            
            // Setup view based on URL parameter
            setupView();
            
            // Start time updates
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // Update countdown display every second
            setInterval(updateCountdownDisplay, 1000);
            
            // Render all content
            renderAll();
            setInterval(renderAll, 30000); // Update status every 30 seconds
        }

        // Start the application
        init();
    </script>
</body>
</html>
