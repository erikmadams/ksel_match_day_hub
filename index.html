<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>KSEL Match Day Lobby</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div class="max-w-6xl mx-auto p-6">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg mb-6 p-6 border-l-4 border-red-500">
            <div class="flex items-center justify-between mb-0 min-h-[72px]">
                <div class="flex items-center">
                    <img src="https://raw.githubusercontent.com/erikmadams/ksel-fortnite-results/main/KSEL_Header_Black_48x198.png" alt="KSEL Logo" style="height: 48px; width: 198px;" class="rounded" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="flex items-center justify-center text-white font-bold rounded text-lg" style="background-color: #EE2A3E; height: 48px; width: 198px; display: none;">
                        KSEL
                    </div>
                </div>
                
                <div class="flex-1 text-center">
                    <h1 class="text-3xl font-bold text-gray-800">Match Day Lobby</h1>
                    <p class="text-gray-600" id="headerSubtitle">Battle Bus Schedule - Live Updates</p>
                </div>
                
                <div class="flex gap-2">
                    <button 
                        onclick="window.location.href='https://erikmadams.github.io/ksel-fortnite-results/'"
                        class="text-white px-6 rounded-lg inline-flex items-center justify-center text-center gap-2 font-medium transition-colors hover:opacity-90 h-11"
                        style="background-color: #EE2A3E"
                    >
                        <i data-lucide="file-text" class="w-4 h-4"></i>
                        Results Entry
                    </button>
                    <button 
                        onclick="window.location.href='https://erikmadams.github.io/fortnite-dashboard/'"
                        class="text-white px-6 rounded-lg inline-flex items-center justify-center text-center gap-2 font-medium transition-colors hover:opacity-90 h-11"
                        style="background-color: #EE2A3E"
                    >
                        <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                        Leaderboard
                    </button>
                </div>
            </div>
        </div>

        <!-- Countdown Timer Display -->
        <div id="countdownDisplay" class="bg-white rounded-xl shadow-lg mb-6 p-6 border-l-4" style="display: none; border-color: #8C15E0;">
            <div class="text-center">
                <div class="flex items-center justify-center gap-2 mb-4">
                    <i data-lucide="timer" class="w-6 h-6" style="color: #8C15E0;"></i>
                    <h2 class="text-2xl font-bold text-gray-800">Next Match</h2>
                </div>
                <div id="countdownTimer" class="text-4xl font-mono font-bold mb-2" style="color: #8C15E0;">
                    --d --h --m --s
                </div>
                <div id="countdownTargetDate" class="text-gray-600 text-lg">
                    Loading...
                </div>
            </div>
        </div>

        <!-- Admin Countdown Controls -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 admin-section" style="display: none;">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="timer" class="w-5 h-5 text-red-600"></i>
                    Countdown Timer Control
                </h2>
                <button 
                    id="toggleCountdownBtn"
                    onclick="toggleCountdown()"
                    class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg inline-flex items-center justify-center gap-2 font-medium transition-colors text-sm"
                >
                    <i data-lucide="power" class="w-4 h-4"></i>
                    <span id="toggleCountdownText">Enable Countdown</span>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Timer Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Target Date</label>
                            <input 
                                type="date" 
                                id="countdownDate"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Target Time</label>
                            <input 
                                type="time" 
                                id="countdownTime"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                            >
                        </div>
                        <button 
                            onclick="setNextThursday()"
                            class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors"
                        >
                            Set to Next Thursday 7:00 PM
                        </button>
                        <button 
                            onclick="updateCountdownTarget()"
                            class="w-full text-white px-4 py-2 rounded-lg font-medium transition-colors hover:opacity-90"
                            style="background-color: #EE2A3E"
                        >
                            Update Countdown Target
                        </button>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Current Status</h3>
                    <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                        <div class="flex justify-between">
                            <span class="text-sm font-medium text-gray-600">Timer Status:</span>
                            <span id="timerStatus" class="text-sm font-bold text-gray-800">Disabled</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm font-medium text-gray-600">Target Date:</span>
                            <span id="currentTargetDate" class="text-sm font-bold text-gray-800">Not Set</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm font-medium text-gray-600">Time Remaining:</span>
                            <span id="adminTimeRemaining" class="text-sm font-bold text-gray-800">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Time Display -->
        <div class="bg-white rounded-xl shadow-lg mb-6 p-4">
            <div class="text-center">
                <div class="text-lg font-medium text-gray-700">Current Time</div>
                <div class="text-3xl font-bold text-gray-800" id="currentTime">Loading...</div>
            </div>
        </div>

        <!-- Bus Schedules -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Schedule A -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="clock" class="w-5 h-5 text-red-600"></i>
                        Bus Schedule A - 3:30 Release
                    </h2>
                    <div class="flex gap-2 admin-controls" style="display: none;">
                        <button 
                            onclick="addBusLaunch('A')"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg inline-flex items-center justify-center gap-2 font-medium transition-colors text-sm"
                        >
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Add Bus
                        </button>
                        <button 
                            onclick="clearSchedule('A')"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg inline-flex items-center justify-center gap-2 font-medium transition-colors text-sm"
                        >
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                            Clear
                        </button>
                    </div>
                </div>
                <div id="launchScheduleA" class="space-y-3 max-h-[800px] overflow-y-auto">
                    <p class="text-gray-500 text-center py-8">No buses scheduled for Schedule A</p>
                </div>
            </div>

            <!-- Schedule B -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="clock" class="w-5 h-5 text-red-600"></i>
                        Bus Schedule B - 4:00 Release
                    </h2>
                    <div class="flex gap-2 admin-controls" style="display: none;">
                        <button 
                            onclick="addBusLaunch('B')"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg inline-flex items-center justify-center gap-2 font-medium transition-colors text-sm"
                        >
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Add Bus
                        </button>
                        <button 
                            onclick="clearSchedule('B')"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg inline-flex items-center justify-center gap-2 font-medium transition-colors text-sm"
                        >
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                            Clear
                        </button>
                    </div>
                </div>
                <div id="launchScheduleB" class="space-y-3 max-h-[800px] overflow-y-auto">
                    <p class="text-gray-500 text-center py-8">No buses scheduled for Schedule B</p>
                </div>
            </div>
        </div>

        <!-- Admin Team Management -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 admin-section" style="display: none;">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="users" class="w-5 h-5 text-red-600"></i>
                    Team Management
                </h2>
                <div class="flex gap-2">
                    <button 
                        onclick="randomizeTeams()"
                        class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg inline-flex items-center justify-center gap-2 font-medium transition-colors text-sm"
                    >
                        <i data-lucide="shuffle" class="w-4 h-4"></i>
                        Randomize
                    </button>
                </div>
            </div>
            <div id="teamSummary">
                <!-- Team summary populated by JavaScript -->
            </div>
        </div>

        <!-- Tournament Status -->
        <div class="bg-white rounded-xl shadow-lg p-6 admin-section" style="display: none;">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i data-lucide="activity" class="w-5 h-5 text-red-600"></i>
                Tournament Status
            </h2>
            <div id="tournamentStatus">
                <!-- Tournament status populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Team Assignment Modal -->
    <div id="busTeamModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-lg max-w-lg w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800" id="busTeamModalTitle">Assign Teams to Bus</h3>
                    <button onclick="closeBusTeamModal()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>

                <!-- Method Selection Tabs -->
                <div class="mb-4">
                    <div class="flex border-b border-gray-200">
                        <button 
                            id="manualTabBtn"
                            onclick="switchTeamInputMethod('manual')"
                            class="px-4 py-2 text-sm font-medium border-b-2 border-red-500 text-red-600"
                        >
                            Manual Entry
                        </button>
                        <button 
                            id="csvTabBtn"
                            onclick="switchTeamInputMethod('csv')"
                            class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700"
                        >
                            CSV Upload
                        </button>
                    </div>
                </div>

                <!-- Manual Entry -->
                <div id="manualEntry" class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Team Names (one per line)</label>
                    <textarea 
                        id="individualTeamNames" 
                        rows="10" 
                        placeholder="Enter team names, one per line..."
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                    ></textarea>
                    <div class="text-sm text-gray-500 mt-1">
                        Current count: <span id="teamCount">0</span> teams
                    </div>
                </div>

                <!-- CSV Upload -->
                <div id="csvEntry" class="mb-4" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload CSV File</label>
                    <input 
                        type="file" 
                        id="csvFileInput" 
                        accept=".csv"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                        onchange="handleCSVUpload(event)"
                    >
                    <div class="mt-2 text-sm text-gray-500">
                        <p>Upload a CSV file with team names in the first column.</p>
                    </div>
                    <div id="csvPreview" class="mt-3 p-3 bg-gray-50 rounded-lg" style="display: none;">
                        <h4 class="font-medium text-gray-700 mb-2">Preview:</h4>
                        <div id="csvPreviewContent" class="text-sm text-gray-600"></div>
                    </div>
                </div>

                <div class="flex justify-end gap-2">
                    <button 
                        onclick="closeBusTeamModal()"
                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors"
                    >
                        Cancel
                    </button>
                    <button 
                        onclick="saveIndividualBusTeams()"
                        class="text-white px-4 py-2 rounded-lg font-medium transition-colors hover:opacity-90"
                        style="background-color: #EE2A3E"
                    >
                        Save Teams
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Match Key Modal -->
    <div id="matchKeyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-lg max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800" id="matchKeyModalTitle">Edit Match Key</h3>
                    <button onclick="closeMatchKeyModal()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Match Key</label>
                    <input 
                        type="text" 
                        id="matchKeyInput" 
                        placeholder="Enter match key for this bus" 
                        maxlength="50"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500 text-lg font-mono"
                    >
                </div>
                <div class="flex justify-end gap-2">
                    <button 
                        onclick="closeMatchKeyModal()"
                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors"
                    >
                        Cancel
                    </button>
                    <button 
                        onclick="saveMatchKey()"
                        class="text-white px-4 py-2 rounded-lg font-medium transition-colors hover:opacity-90"
                        style="background-color: #EE2A3E"
                    >
                        Save Match Key
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Google Sheets Configuration
        const GOOGLE_SHEETS_CONFIG = {
            // Replace with your actual Google Apps Script deployment URL
            SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwdmK-Cc8mZvIUbpiIjO2vTu-dzAAt9cVNajrWfuyq_TT-hgXn6oRIyRoq03WcFUptJ/exec',
            CORS_PROXY: 'https://api.allorigins.win/raw?url='
        };

        // Global Variables
        let busScheduleA = [];
        let busScheduleB = [];
        let currentBusId = null;
        let currentBusColumn = null;
        let currentMatchKeyBusId = null;
        let currentMatchKeyColumn = null;
        let lastSyncTimestamp = 0;
        let pollInterval = null;

        // Countdown Timer State
        let countdownState = {
            enabled: false,
            targetDate: null,
            intervalId: null
        };

        // Check URL for admin view
        const isAdminView = window.location.hash === '#admin';

        // Utility Functions
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit', 
                second: '2-digit', 
                hour12: true 
            });
            document.getElementById('currentTime').textContent = timeString;
        }

        function formatTime12Hour(time24) {
            const [hours, minutes] = time24.split(':').map(Number);
            const period = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            return `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
        }

        // Bus Status Functions
        function getBusStatus(bus) {
            const now = new Date();
            
            if (bus.isLaunched && bus.launchTime) {
                const launchTime = new Date(bus.launchTime);
                const timeSinceLaunch = now - launchTime;
                
                // 5 minutes = 300,000 ms
                if (timeSinceLaunch >= 300000) {
                    return 'completed';
                } else {
                    return 'active';
                }
            }
            
            // Check if bus has match key and teams
            const hasMatchKey = bus.matchKey && bus.matchKey.trim().length > 0;
            const hasTeams = bus.teams && bus.teams.length > 0;
            
            if (hasMatchKey && hasTeams) {
                return 'ready';
            } else {
                return 'pending';
            }
        }

        function getStatusColor(status) {
            switch(status) {
                case 'completed': return 'bg-red-100 text-red-700 border-red-300';
                case 'active': return 'bg-green-100 text-green-700 border-green-300';
                case 'ready': return 'bg-yellow-100 text-yellow-700 border-yellow-300';
                case 'pending': return 'bg-gray-100 text-gray-600 border-gray-300';
                default: return 'bg-gray-100 text-gray-600 border-gray-300';
            }
        }

        function getStatusIcon(status) {
            switch(status) {
                case 'completed': return 'x-circle';
                case 'active': return 'play-circle';
                case 'ready': return 'clock';
                case 'pending': return 'circle-dashed';
                default: return 'circle-dashed';
            }
        }

        // Google Sheets Integration Functions
        async function saveToGoogleSheets() {
            if (!isAdminView) return;
            
            const tournamentData = {
                busScheduleA: busScheduleA,
                busScheduleB: busScheduleB,
                countdownState: countdownState,
                timestamp: Date.now()
            };

            try {
                console.log('Saving tournament data to Google Sheets...');
                
                const response = await fetch(GOOGLE_SHEETS_CONFIG.CORS_PROXY + encodeURIComponent(GOOGLE_SHEETS_CONFIG.SCRIPT_URL), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify(tournamentData)
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        console.log('âœ… Data saved to Google Sheets successfully');
                        lastSyncTimestamp = tournamentData.timestamp;
                        
                        // Update status indicator
                        showSyncStatus('saved', 'Data saved to Google Sheets');
                    } else {
                        throw new Error(result.error || 'Unknown error');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('âŒ Error saving to Google Sheets:', error);
                showSyncStatus('error', 'Failed to save to Google Sheets. Using local storage as backup.');
                
                // Fall back to local storage
                saveToLocalStorage();
            }
        }

        async function loadFromGoogleSheets() {
            try {
                console.log('Loading tournament data from Google Sheets...');
                
                const response = await fetch(GOOGLE_SHEETS_CONFIG.CORS_PROXY + encodeURIComponent(GOOGLE_SHEETS_CONFIG.SCRIPT_URL + '?action=read'));
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.data && result.timestamp > lastSyncTimestamp) {
                        console.log('ðŸ“¥ Loading fresh data from Google Sheets');
                        
                        // Update local data
                        busScheduleA = Array.isArray(result.data.busScheduleA) ? result.data.busScheduleA : [];
                        busScheduleB = Array.isArray(result.data.busScheduleB) ? result.data.busScheduleB : [];
                        
                        // Update countdown state
                        if (result.data.countdownState) {
                            const wasEnabled = countdownState.enabled;
                            countdownState = { ...countdownState, ...result.data.countdownState };
                            
                            // Handle countdown state changes
                            if (countdownState.enabled && !wasEnabled) {
                                startCountdown();
                            } else if (!countdownState.enabled && wasEnabled) {
                                stopCountdown();
                            }
                        }
                        
                        lastSyncTimestamp = result.timestamp;
                        
                        console.log(`âœ… Loaded from Google Sheets - A: ${busScheduleA.length}, B: ${busScheduleB.length}`);
                        showSyncStatus('loaded', 'Data updated from Google Sheets');
                        
                        // Also save to local storage as backup
                        saveToLocalStorage();
                        
                        return true;
                    } else {
                        console.log('ðŸ“Š Google Sheets data is up to date');
                        return false;
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('âŒ Error loading from Google Sheets:', error);
                showSyncStatus('error', 'Could not connect to Google Sheets. Using local storage.');
                return false;
            }
        }

        function startPolling() {
            if (isAdminView) return; // Only poll in player view
            
            console.log('ðŸ”„ Starting real-time polling for updates...');
            
            pollInterval = setInterval(async () => {
                const updated = await loadFromGoogleSheets();
                if (updated) {
                    renderAll();
                }
            }, 5000); // Poll every 5 seconds
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
                console.log('â¹ï¸ Stopped polling for updates');
            }
        }

        function showSyncStatus(type, message) {
            // Remove existing status indicators
            const existingStatus = document.getElementById('syncStatus');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            // Create status indicator
            const statusDiv = document.createElement('div');
            statusDiv.id = 'syncStatus';
            statusDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 500;
                z-index: 1000;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            `;
            
            switch (type) {
                case 'saved':
                    statusDiv.style.backgroundColor = '#10b981';
                    statusDiv.style.color = 'white';
                    statusDiv.innerHTML = 'âœ… ' + message;
                    break;
                case 'loaded':
                    statusDiv.style.backgroundColor = '#3b82f6';
                    statusDiv.style.color = 'white';
                    statusDiv.innerHTML = 'ðŸ“¥ ' + message;
                    break;
                case 'error':
                    statusDiv.style.backgroundColor = '#ef4444';
                    statusDiv.style.color = 'white';
                    statusDiv.innerHTML = 'âŒ ' + message;
                    break;
            }
            
            document.body.appendChild(statusDiv);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (statusDiv) {
                    statusDiv.remove();
                }
            }, 3000);
        }

        // Storage Functions (Enhanced)
        function saveBusSchedules() {
            if (isAdminView) {
                // In admin view, save to Google Sheets
                saveToGoogleSheets();
            } else {
                // In player view, just save locally (shouldn't happen often)
                saveToLocalStorage();
            }
        }

        function saveToLocalStorage() {
            const scheduleData = {
                busScheduleA: busScheduleA,
                busScheduleB: busScheduleB,
                countdownState: countdownState,
                timestamp: Date.now()
            };
            try {
                localStorage.setItem('kselBusSchedules', JSON.stringify(scheduleData));
                console.log('ðŸ’¾ Data saved to local storage as backup');
            } catch (e) {
                console.error('Failed to save to local storage:', e);
            }
        }

        function loadBusSchedules() {
            if (isAdminView) {
                // Admin view: Load from Google Sheets first, then local storage as fallback
                loadFromGoogleSheets().then(loaded => {
                    if (!loaded) {
                        loadFromLocalStorage();
                    }
                    renderAll();
                }).catch(error => {
                    console.error('Error in loadBusSchedules:', error);
                    loadFromLocalStorage();
                    renderAll();
                });
            } else {
                // Player view: Load from Google Sheets first, then start polling
                loadFromGoogleSheets().then(loaded => {
                    if (!loaded) {
                        loadFromLocalStorage();
                    }
                    renderAll();
                    startPolling();
                }).catch(error => {
                    console.error('Error in loadBusSchedules:', error);
                    loadFromLocalStorage();
                    renderAll();
                    startPolling();
                });
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedSchedules = localStorage.getItem('kselBusSchedules');
                if (savedSchedules) {
                    const parsed = JSON.parse(savedSchedules);
                    busScheduleA = Array.isArray(parsed.busScheduleA) ? parsed.busScheduleA : [];
                    busScheduleB = Array.isArray(parsed.busScheduleB) ? parsed.busScheduleB : [];
                    
                    if (parsed.countdownState) {
                        countdownState = { ...countdownState, ...parsed.countdownState };
                    }
                    
                    console.log(`ðŸ’¾ Loaded from local storage - A: ${busScheduleA.length}, B: ${busScheduleB.length}`);
                } else {
                    busScheduleA = [];
                    busScheduleB = [];
                }
            } catch (e) {
                console.error('Error loading from local storage:', e);
                busScheduleA = [];
                busScheduleB = [];
            }
        }

        function saveCountdownState() {
            const stateToSave = {
                enabled: countdownState.enabled,
                targetDate: countdownState.targetDate
            };
            localStorage.setItem('kselCountdownState', JSON.stringify(stateToSave));
        }

        function loadCountdownState() {
            try { 
                const savedState = localStorage.getItem('kselCountdownState');
                if (savedState) {
                    const parsed = JSON.parse(savedState);
                    countdownState.enabled = parsed.enabled || false;
                    countdownState.targetDate = parsed.targetDate || null;
                }
            } catch (e) {
                console.log('Error loading countdown state:', e);
                countdownState.enabled = false;
                countdownState.targetDate = null;
            }
        }

        // Bus Management Functions
        function addBusLaunch(column) {
            if (!isAdminView) return;
            
            const busName = prompt('Enter bus name:');
            const time = prompt(`Enter launch time for Schedule ${column} (HH:MM in 24-hour format):`);
            
            if (time && busName && /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(time)) {
                const newBus = {
                    id: Date.now(),
                    time: time,
                    busNumber: busName,
                    matchKey: '',
                    isLaunched: false,
                    launchTime: null,
                    teams: []
                };
                
                if (column === 'A') {
                    busScheduleA.push(newBus);
                    busScheduleA.sort((a, b) => a.time.localeCompare(b.time));
                } else {
                    busScheduleB.push(newBus);
                    busScheduleB.sort((a, b) => a.time.localeCompare(b.time));
                }

                saveBusSchedules();
                renderAll();
            } else if (time && busName) {
                alert('Please enter time in HH:MM format (24-hour)');
            }
        }

        function removeBus(busId, column) {
            if (!isAdminView) return;
            
            const scheduleData = column === 'A' ? busScheduleA : busScheduleB;
            const bus = scheduleData.find(b => b.id === busId);
            
            if (bus && confirm(`Remove ${bus.busNumber} and all its team assignments?`)) {
                if (column === 'A') {
                    const index = busScheduleA.findIndex(b => b.id === busId);
                    if (index > -1) busScheduleA.splice(index, 1);
                } else {
                    const index = busScheduleB.findIndex(b => b.id === busId);
                    if (index > -1) busScheduleB.splice(index, 1);
                }
                saveBusSchedules();
                renderAll();
            }
        }

        function clearSchedule(column) {
            if (!isAdminView) return;
            
            if (confirm(`Are you sure you want to clear Schedule ${column}?`)) {
                if (column === 'A') {
                    busScheduleA = [];
                } else {
                    busScheduleB = [];
                }
                saveBusSchedules();
                renderAll();
            }
        }

        function toggleBusLaunch(busId, column) {
            if (!isAdminView) return;
            
            const scheduleData = column === 'A' ? busScheduleA : busScheduleB;
            const bus = scheduleData.find(b => b.id === busId);
            
            if (bus) {
                bus.isLaunched = !bus.isLaunched;
                if (bus.isLaunched) {
                    bus.launchTime = new Date().toISOString();
                } else {
                    bus.launchTime = null;
                }
                saveBusSchedules();
                renderAll();
            }
        }

        // Match Key Management
        function openMatchKeyModal(busId, column) {
            if (!isAdminView) return;
            
            currentMatchKeyBusId = busId;
            currentMatchKeyColumn = column;
            
            const scheduleData = column === 'A' ? busScheduleA : busScheduleB;
            const bus = scheduleData.find(b => b.id === busId);
            
            if (bus) {
                document.getElementById('matchKeyModalTitle').textContent = `Edit Match Key - ${bus.busNumber}`;
                document.getElementById('matchKeyInput').value = bus.matchKey || '';
                document.getElementById('matchKeyModal').classList.remove('hidden');
                
                setTimeout(() => {
                    document.getElementById('matchKeyInput').focus();
                }, 100);
            }
        }

        function closeMatchKeyModal() {
            document.getElementById('matchKeyModal').classList.add('hidden');
            currentMatchKeyBusId = null;
            currentMatchKeyColumn = null;
        }

        function saveMatchKey() {
            if (!isAdminView || !currentMatchKeyBusId || !currentMatchKeyColumn) return;
            
            const scheduleData = currentMatchKeyColumn === 'A' ? busScheduleA : busScheduleB;
            const bus = scheduleData.find(b => b.id === currentMatchKeyBusId);
            
            if (bus) {
                const matchKey = document.getElementById('matchKeyInput').value.trim();
                bus.matchKey = matchKey;
                
                saveBusSchedules();
                renderAll();
                closeMatchKeyModal();
            }
        }

        // Team Assignment Functions
        function openBusTeamModal(busId, column) {
            if (!isAdminView) return;
            
            currentBusId = busId;
            currentBusColumn = column;
            
            const scheduleData = column === 'A' ? busScheduleA : busScheduleB;
            const bus = scheduleData.find(b => b.id === busId);
            
            if (bus) {
                document.getElementById('busTeamModalTitle').textContent = `Assign Teams to ${bus.busNumber}`;
                document.getElementById('individualTeamNames').value = bus.teams.join('\n');
                updateTeamCount();
                switchTeamInputMethod('manual');
                document.getElementById('busTeamModal').classList.remove('hidden');
            }
        }

        function closeBusTeamModal() {
            document.getElementById('busTeamModal').classList.add('hidden');
            currentBusId = null;
            currentBusColumn = null;
        }

        function saveIndividualBusTeams() {
            if (!isAdminView || !currentBusId || !currentBusColumn) return;
            
            const scheduleData = currentBusColumn === 'A' ? busScheduleA : busScheduleB;
            const bus = scheduleData.find(b => b.id === currentBusId);
            
            if (bus) {
                const teamNames = document.getElementById('individualTeamNames').value
                    .split('\n')
                    .map(name => name.trim())
                    .filter(name => name.length > 0);
                
                bus.teams = teamNames;
                saveBusSchedules();
                renderAll();
                closeBusTeamModal();
            }
        }

        function switchTeamInputMethod(method) {
            const manualTab = document.getElementById('manualTabBtn');
            const csvTab = document.getElementById('csvTabBtn');
            const manualEntry = document.getElementById('manualEntry');
            const csvEntry = document.getElementById('csvEntry');
            
            if (method === 'manual') {
                manualTab.className = 'px-4 py-2 text-sm font-medium border-b-2 border-red-500 text-red-600';
                csvTab.className = 'px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700';
                manualEntry.style.display = 'block';
                csvEntry.style.display = 'none';
            } else {
                manualTab.className = 'px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700';
                csvTab.className = 'px-4 py-2 text-sm font-medium border-b-2 border-red-500 text-red-600';
                manualEntry.style.display = 'none';
                csvEntry.style.display = 'block';
            }
        }

        function updateTeamCount() {
            const textarea = document.getElementById('individualTeamNames');
            const teams = textarea.value
                .split('\n')
                .map(name => name.trim())
                .filter(name => name.length > 0);
            
            document.getElementById('teamCount').textContent = teams.length;
        }

        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const csvContent = e.target.result;
                const lines = csvContent.split('\n');
                
                const teams = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        const columns = line.split(',');
                        const teamName = columns[0].trim().replace(/"/g, '');
                        if (teamName) {
                            teams.push(teamName);
                        }
                    }
                }
                
                if (teams.length > 0) {
                    document.getElementById('individualTeamNames').value = teams.join('\n');
                    updateTeamCount();
                    
                    const previewDiv = document.getElementById('csvPreview');
                    const previewContent = document.getElementById('csvPreviewContent');
                    previewContent.innerHTML = `<p><strong>${teams.length} teams found</strong></p>`;
                    previewDiv.style.display = 'block';
                    
                    switchTeamInputMethod('manual');
                } else {
                    alert('No team names found in the CSV file');
                }
            };
            reader.readAsText(file);
        }

        // Countdown Functions
        function toggleCountdown() {
            if (!isAdminView) return;
            
            countdownState.enabled = !countdownState.enabled;
            
            if (countdownState.enabled) {
                if (!countdownState.targetDate) {
                    alert('Please set a target date and time first');
                    countdownState.enabled = false;
                    return;
                }
                startCountdown();
            } else {
                stopCountdown();
            }
            
            saveCountdownState();
            updateCountdownUI();
        }

        function startCountdown() {
            if (countdownState.intervalId) {
                clearInterval(countdownState.intervalId);
            }
            
            countdownState.intervalId = setInterval(updateCountdownDisplay, 1000);
            updateCountdownDisplay();
            document.getElementById('countdownDisplay').style.display = 'block';
        }

        function stopCountdown() {
            if (countdownState.intervalId) {
                clearInterval(countdownState.intervalId);
                countdownState.intervalId = null;
            }
            document.getElementById('countdownDisplay').style.display = 'none';
        }

        function updateCountdownDisplay() {
            if (!countdownState.enabled || !countdownState.targetDate) {
                return;
            }

            const now = new Date();
            const target = new Date(countdownState.targetDate);
            const timeDiff = target.getTime() - now.getTime();

            if (timeDiff <= 0) {
                document.getElementById('countdownTimer').textContent = 'TOURNAMENT TIME!';
                document.getElementById('countdownTimer').className = 'text-4xl font-mono font-bold text-red-600 mb-2 animate-pulse';
                return;
            }

            const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);

            const formattedTime = `${days}d ${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m ${seconds.toString().padStart(2, '0')}s`;
            
            const timerElement = document.getElementById('countdownTimer');
            timerElement.textContent = formattedTime;
            timerElement.className = 'text-4xl font-mono font-bold mb-2';
            timerElement.style.color = '#8C15E0';
            
            if (isAdminView) {
                document.getElementById('adminTimeRemaining').textContent = formattedTime;
            }
        }

        function updateCountdownTarget() {
            if (!isAdminView) return;
            
            const dateInput = document.getElementById('countdownDate').value;
            const timeInput = document.getElementById('countdownTime').value;
            
            if (!dateInput || !timeInput) {
                alert('Please set both date and time');
                return;
            }
            
            const targetDateTime = new Date(`${dateInput}T${timeInput}`);
            const now = new Date();
            
            if (targetDateTime <= now) {
                alert('Target date and time must be in the future');
                return;
            }
            
            countdownState.targetDate = targetDateTime.toISOString();
            
            const formattedTarget = targetDateTime.toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
            
            document.getElementById('countdownTargetDate').textContent = formattedTarget;
            document.getElementById('currentTargetDate').textContent = formattedTarget;

            saveCountdownState();
            
            if (countdownState.enabled) {
                startCountdown();
            }
            
            alert('Countdown target updated successfully!');
        }

        function setNextThursday() {
            if (!isAdminView) return;
            
            const now = new Date();
            const daysUntilThursday = (4 - now.getDay() + 7) % 7;
            const nextThursday = new Date(now);
            
            if (daysUntilThursday === 0 && now.getHours() >= 19) {
                nextThursday.setDate(now.getDate() + 7);
            } else {
                nextThursday.setDate(now.getDate() + (daysUntilThursday || 7));
            }
            
            nextThursday.setHours(19, 0, 0, 0);
            
            const dateString = nextThursday.toISOString().split('T')[0];
            const timeString = '19:00';
            
            document.getElementById('countdownDate').value = dateString;
            document.getElementById('countdownTime').value = timeString;
        }

        function updateCountdownUI() {
            if (!isAdminView) return;
            
            const toggleBtn = document.getElementById('toggleCountdownText');
            const statusText = document.getElementById('timerStatus');
            
            if (countdownState.enabled) {
                toggleBtn.textContent = 'Disable Countdown';
                statusText.textContent = 'Active';
                statusText.className = 'text-sm font-bold text-green-600';
            } else {
                toggleBtn.textContent = 'Enable Countdown';
                statusText.textContent = 'Disabled';
                statusText.className = 'text-sm font-bold text-gray-800';
            }
        }

        // Rendering Functions
        function renderSchedule() {
            renderScheduleColumn('A');
            renderScheduleColumn('B');
        }

        function renderScheduleColumn(column) {
            const scheduleData = column === 'A' ? busScheduleA : busScheduleB;
            const scheduleContainer = document.getElementById(`launchSchedule${column}`);
            
            if (scheduleData.length === 0) {
                scheduleContainer.innerHTML = `<p class="text-gray-500 text-center py-8">No buses scheduled for Schedule ${column}</p>`;
                return;
            }

            scheduleContainer.innerHTML = '';

            scheduleData.forEach(bus => {
                const status = getBusStatus(bus);
                const statusColor = getStatusColor(status);
                const statusIcon = getStatusIcon(status);
                
                const busElement = document.createElement('div');
                busElement.className = `border-2 rounded-lg p-4 transition-colors ${statusColor}`;
                
                const launchCheckboxHtml = isAdminView ? `
                    <div class="flex items-center gap-2 mb-2">
                        <input 
                            type="checkbox" 
                            id="launch-${bus.id}" 
                            ${bus.isLaunched ? 'checked' : ''} 
                            onchange="toggleBusLaunch(${bus.id}, '${column}')"
                            class="w-4 h-4 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500"
                        >
                        <label for="launch-${bus.id}" class="text-sm font-medium text-gray-700">
                            ${bus.isLaunched ? 'Bus Launched' : 'Launch Bus'}
                        </label>
                    </div>
                ` : '';
                
                const adminButtonsHtml = isAdminView ? `
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-medium opacity-75">${bus.teams.length} teams assigned</span>
                        <div class="flex gap-1">
                            <button 
                                onclick="openMatchKeyModal(${bus.id}, '${column}')" 
                                class="text-purple-500 hover:text-purple-700 p-1"
                                title="Set match key"
                            >
                                <i data-lucide="key" class="w-4 h-4"></i>
                            </button>
                            <button 
                                onclick="openBusTeamModal(${bus.id}, '${column}')" 
                                class="text-blue-500 hover:text-blue-700 p-1"
                                title="Assign teams"
                            >
                                <i data-lucide="users" class="w-4 h-4"></i>
                            </button>
                            <button 
                                onclick="removeBus(${bus.id}, '${column}')" 
                                class="text-red-500 hover:text-red-700 p-1"
                                title="Remove bus"
                            >
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                ` : `
                    <div class="text-center mb-2">
                        <span class="text-xs font-medium opacity-75">${bus.teams.length} teams assigned</span>
                    </div>
                `;
                
                busElement.innerHTML = `
                    <div class="mb-4">
                        <div class="text-center">
                            <div class="text-xl font-bold text-gray-800 mb-2">${bus.busNumber}</div>
                        </div>
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <i data-lucide="${statusIcon}" class="w-5 h-5"></i>
                                <span class="font-bold text-lg">${formatTime12Hour(bus.time)}</span>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-mono bg-black bg-opacity-20 px-3 py-2 rounded font-bold">
                                    Match Key: ${bus.matchKey || 'Not set'}
                                </div>
                            </div>
                        </div>
                    </div>
                    ${launchCheckboxHtml}
                    ${adminButtonsHtml}
                    <div class="space-y-1">
                        ${bus.teams.map(team => `
                            <div class="bg-white bg-opacity-50 rounded px-2 py-1 text-sm font-medium">
                                ${team}
                            </div>
                        `).join('')}
                    </div>
                `;
                
                scheduleContainer.appendChild(busElement);
            });

            lucide.createIcons();
        }

        function getAllBuses() {
            return [...busScheduleA, ...busScheduleB];
        }

        function renderTeamSummary() {
            const summaryContainer = document.getElementById('teamSummary');
            const allBuses = getAllBuses();
            const totalTeams = allBuses.reduce((sum, bus) => sum + bus.teams.length, 0);
            
            summaryContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-blue-50 rounded-lg p-4 text-center border border-blue-200">
                        <div class="text-3xl font-bold text-blue-600">${totalTeams}</div>
                        <div class="text-sm text-blue-600 font-medium">Total Teams</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 text-center border border-green-200">
                        <div class="text-3xl font-bold text-green-600">${allBuses.length}</div>
                        <div class="text-sm text-green-600 font-medium">Total Buses</div>
                    </div>
                    <div class="bg-orange-50 rounded-lg p-4 text-center border border-orange-200">
                        <div class="text-3xl font-bold text-orange-600">${busScheduleA.length}</div>
                        <div class="text-sm text-orange-600 font-medium">Schedule A Buses</div>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4 text-center border border-purple-200">
                        <div class="text-3xl font-bold text-purple-600">${busScheduleB.length}</div>
                        <div class="text-sm text-purple-600 font-medium">Schedule B Buses</div>
                    </div>
                </div>
            `;
        }

        function renderTournamentStatus() {
            const statusContainer = document.getElementById('tournamentStatus');
            const allBuses = getAllBuses();
            
            let pendingCount = 0;
            let readyCount = 0;
            let activeCount = 0;
            let completedCount = 0;
            
            allBuses.forEach(bus => {
                const status = getBusStatus(bus);
                switch(status) {
                    case 'pending': pendingCount++; break;
                    case 'ready': readyCount++; break;
                    case 'active': activeCount++; break;
                    case 'completed': completedCount++; break;
                }
            });

            statusContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-gray-50 rounded-lg p-4 text-center border border-gray-200">
                        <div class="text-2xl font-bold text-gray-600">${pendingCount}</div>
                        <div class="text-sm text-gray-600 font-medium">Pending Setup</div>
                    </div>
                    <div class="bg-yellow-50 rounded-lg p-4 text-center border border-yellow-200">
                        <div class="text-2xl font-bold text-yellow-600">${readyCount}</div>
                        <div class="text-sm text-yellow-600 font-medium">Ready to Launch</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 text-center border border-green-200">
                        <div class="text-2xl font-bold text-green-600">${activeCount}</div>
                        <div class="text-sm text-green-600 font-medium">Active Buses</div>
                    </div>
                    <div class="bg-red-50 rounded-lg p-4 text-center border border-red-200">
                        <div class="text-2xl font-bold text-red-600">${completedCount}</div>
                        <div class="text-sm text-red-600 font-medium">Completed</div>
                    </div>
                </div>
            `;
        }

        function randomizeTeams() {
            if (!isAdminView) return;
            
            const allBuses = getAllBuses();
            if (allBuses.length === 0) {
                alert('No buses available to randomize teams');
                return;
            }
            
            if (confirm('This will randomize all team assignments across both schedules. Continue?')) {
                const allTeams = allBuses.flatMap(bus => bus.teams);
                const shuffledTeams = [...allTeams].sort(() => Math.random() - 0.5);
                
                let teamIndex = 0;
                allBuses.forEach(bus => {
                    const teamCount = bus.teams.length;
                    bus.teams = shuffledTeams.slice(teamIndex, teamIndex + teamCount);
                    teamIndex += teamCount;
                });

                saveBusSchedules();
                renderAll();
            }
        }

        function renderAll() {
            renderSchedule();
            if (isAdminView) {
                renderTeamSummary();
                renderTournamentStatus();
                updateCountdownUI();
            }
        }

        // Modal Event Handlers
        window.onclick = function(event) {
            const busTeamModal = document.getElementById('busTeamModal');
            const matchKeyModal = document.getElementById('matchKeyModal');
            
            if (event.target === busTeamModal) {
                closeBusTeamModal();
            }
            if (event.target === matchKeyModal) {
                closeMatchKeyModal();
            }
        }

        // Setup and Initialization
        function setupView() {
            loadCountdownState();
            loadBusSchedules(); // This now handles Google Sheets integration
            
            if (isAdminView) {
                document.querySelectorAll('.admin-section').forEach(element => {
                    element.style.display = 'block';
                });
                
                document.querySelectorAll('.admin-controls').forEach(element => {
                    element.style.display = 'flex';
                });
                
                document.title = 'KSEL Match Day Hub - Admin';
                document.getElementById('headerSubtitle').textContent = 'Battle Bus Schedule â€¢ Team Assignments â€¢ Live Updates';
                
                if (!countdownState.targetDate) {
                    setNextThursday();
                } else {
                    const targetDate = new Date(countdownState.targetDate);
                    const dateString = targetDate.toISOString().split('T')[0];
                    const timeString = targetDate.toTimeString().substring(0, 5);

                    document.getElementById('countdownDate').value = dateString;
                    document.getElementById('countdownTime').value = timeString;

                    const formattedTarget = targetDate.toLocaleString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    });
                    document.getElementById('countdownTargetDate').textContent = formattedTarget;
                    document.getElementById('currentTargetDate').textContent = formattedTarget;
                }

                // Add connection status indicator for admin
                addConnectionStatusIndicator();
                
            } else {    
                document.title = 'KSEL Match Day - Live View';
                document.getElementById('headerSubtitle').textContent = 'Battle Bus Schedule - Live Updates';
                
                // Add "LIVE" indicator for player view
                addLiveIndicator();
            }
            
            if (countdownState.enabled && countdownState.targetDate) {
                if (!isAdminView) {
                    const targetDate = new Date(countdownState.targetDate);
                    const formattedTarget = targetDate.toLocaleString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    });
                    document.getElementById('countdownTargetDate').textContent = formattedTarget;
                }
                startCountdown();
            }
        }

        function addConnectionStatusIndicator() {
            const header = document.querySelector('.flex.items-center.justify-between');
            if (header) {
                const statusDiv = document.createElement('div');
                statusDiv.id = 'connectionStatus';
                statusDiv.className = 'flex items-center gap-2 text-sm';
                statusDiv.innerHTML = `
                    <div class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse"></div>
                    <span>Connecting to Google Sheets...</span>
                `;
                header.appendChild(statusDiv);
            }
        }

        function addLiveIndicator() {
            const header = document.querySelector('.flex-1.text-center');
            if (header) {
                const liveIndicator = document.createElement('div');
                liveIndicator.className = 'flex items-center justify-center gap-2 mt-2';
                liveIndicator.innerHTML = `
                    <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                    <span class="text-sm text-red-600 font-medium">LIVE</span>
                `;
                header.appendChild(liveIndicator);
            }
        }

        function updateConnectionStatus(connected) {
            const statusDiv = document.getElementById('connectionStatus');
            if (statusDiv) {
                if (connected) {
                    statusDiv.innerHTML = `
                        <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                        <span>Google Sheets Connected</span>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                        <span>Using Local Storage</span>
                    `;
                }
            }
        }

        function init() {
            lucide.createIcons();
            setupView();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            setInterval(updateCountdownDisplay, 1000);
            renderAll();
            setInterval(renderAll, 30000);
            
            // Test Google Sheets connection
            setTimeout(async () => {
                try {
                    await loadFromGoogleSheets();
                    updateConnectionStatus(true);
                } catch (error) {
                    updateConnectionStatus(false);
                }
            }, 2000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopPolling();
        });

        // Add event listener for team count updates
        document.addEventListener('DOMContentLoaded', function() {
            const textarea = document.getElementById('individualTeamNames');
            if (textarea) {
                textarea.addEventListener('input', updateTeamCount);
            }
        });

        // Start the application
        init();
    </script>
</body>
</html>
